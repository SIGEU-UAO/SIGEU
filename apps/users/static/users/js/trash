/*
import { emailRegex, passwordRegex } from "/static/js/base.js";
import { validarFormData, formDataToJSON } from "/static/js/modules/forms/utils.js";
import Alert from "/static/js/modules/Alert.js";

/* Reglas de validación
const validationRules = {
  email: [
    { check: value => emailRegex.test(value), msg: "Correo inválido, debe terminar en @uao.edu.co" }
  ],
  password: [
    { check: value => !value || passwordRegex.test(value), msg: "Contraseña inválida" }
  ],
};

//* Selectores
const form = document.querySelector("form.form");
const editButton = document.querySelector(".form__edit");
const formActions = document.querySelector(".form__actions");
const cancelButton = document.getElementById("cancelBtn");
const formFields = document.querySelectorAll(".form input, .form textarea, .form select");

//* Estado inicial
const originalValues = {};
formFields.forEach(field => {
  originalValues[field.name] = field.value;
  if (field.hasAttribute("disabled")) {
    field.dataset.wasDisabled = "true";
  }
});

//* Funciones
function handleEdit(e) {
  e.preventDefault();
  if (formActions) formActions.classList.remove("hide");

  formFields.forEach(field => {
    field.removeAttribute("readonly");
    field.removeAttribute("disabled");
  });

  if (editButton) editButton.style.display = "none";
}

function handleCancel(e) {
  e.preventDefault();
  if (formActions) formActions.classList.add("hide");

  formFields.forEach(field => {
    if (originalValues.hasOwnProperty(field.name)) {
      field.value = originalValues[field.name];
    }
    field.setAttribute("readonly", "true");
    if (field.dataset.wasDisabled === "true") {
      field.setAttribute("disabled", "true");
    }
  });

  if (editButton) editButton.style.display = "inline-block";
}

async function handleSubmit(e) {
  e.preventDefault();
  if (!form) return;

  // Validar
  const formData = new FormData(form);
  if (!validarFormData(formData, validationRules)) return;

  const csrf = (form.querySelector("input[name=csrfmiddlewaretoken]") || {}).value || "";
  const bodyData = JSON.stringify(formDataToJSON(formData)); // aseguramos JSON string

  try {
    const res = await fetch("/users/api/editar/", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrf,
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: bodyData
    });

    const json = await res.json();

    if (res.ok && json.message) {
      Alert.success(json.message || "Perfil actualizado correctamente");

      // Actualizar valores originales
      ["nombres", "apellidos", "telefono", "codigo_estudiante"].forEach(field => {
        if (json[field] !== undefined) {
          const f = form.querySelector(`[name="${field}"]`);
          if (f) {
            f.value = json[field];
            originalValues[field] = json[field];
          }
        }
      });

      formFields.forEach(field => field.setAttribute("readonly", "true"));
      if (formActions) formActions.classList.add("hide");
      if (editButton) editButton.style.display = "inline-block";
    } else if (json.errors) {
      let html = "";
      for (const [field, errs] of Object.entries(json.errors)) {
        html += `<p><strong>${field}:</strong> ${errs.join(", ")}</p>`;
      }
      Alert.error(html);
    } else {
      Alert.error(json.error || "No se pudieron guardar los cambios. Intenta nuevamente.");
    }
  } catch (err) {
    Alert.error("Error de red. Intenta de nuevo.", err);
    console.error(err);
  }
}

//* Listeners
if (editButton) editButton.addEventListener("click", handleEdit);
if (cancelButton) cancelButton.addEventListener("click", handleCancel);
if (form) form.addEventListener("submit", handleSubmit);
document.addEventListener("DOMContentLoaded", () => {
  passwordEyeBtns.addEventListener("click", handlePasswordVisibility);
  form.addEventListener("submit", handleSubmit);
})
*/
/*
document.addEventListener("DOMContentLoaded", function () {
    const editButton = document.querySelector(".form__edit");
    const formActions = document.querySelector(".form__actions");
    const form = document.querySelector(".form");
    const formFields = document.querySelectorAll(".form input, .form textarea, .form select");
    const cancelButton = document.getElementById("cancelBtn");

    if (!editButton || !formActions || !form) return;

    // Guardar valores originales (para "Cancelar")
    const originalValues = {};
    formFields.forEach(field => {
        originalValues[field.name] = field.value;
    });

    // Habilitar edición
    editButton.addEventListener("click", function (e) {
        e.preventDefault();
        formActions.classList.remove("hide");
        formFields.forEach(field => field.removeAttribute("readonly"));
        editButton.style.display = "none";
    });

    // Cancelar edición
    if (cancelButton) {
        cancelButton.addEventListener("click", function (e) {
            e.preventDefault();
            formActions.classList.add("hide");
            formFields.forEach(field => {
                if (originalValues.hasOwnProperty(field.name)) {
                    field.value = originalValues[field.name];
                }
                field.setAttribute("readonly", "true");
            });
            editButton.style.display = "inline-block";
        });
    }

    // Interceptar submit con fetch
    form.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(async resp => {
                console.debug('perfil POST status', resp.status);
                const ct = resp.headers.get('content-type') || '';
                let data = null;
                let text = null;

                if (ct.includes('application/json')) {
                    try {
                        data = await resp.json();
                    } catch (err) {
                        console.error('Failed to parse JSON response', err);
                        text = await resp.text();
                    }
                } else {
                    text = await resp.text();
                }

                if (data && data.success) {
                    // ✅ Éxito
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Perfil actualizado correctamente',
                        showConfirmButton: false,
                        timer: 2000
                    });

                    // Actualizar valores originales
                    ["nombres", "apellidos", "telefono", "codigo_estudiante"].forEach(field => {
                        if (data[field] !== undefined) {
                            const f = form.querySelector(`[name="${field}"]`);
                            if (f) {
                                f.value = data[field];
                                originalValues[field] = data[field];
                            }
                        }
                    });

                    formFields.forEach(field => field.setAttribute("readonly", "true"));
                    formActions.classList.add("hide");
                    editButton.style.display = "inline-block";
                } else if (data && data.errors) {
                    // ❌ Errores de validación
                    let html = "";
                    for (const [field, errs] of Object.entries(data.errors)) {
                        html += `<p><strong>${field}:</strong> ${errs.join(", ")}</p>`;
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Errores de validación',
                        html: html
                    });
                } else {
                    // Error inesperado
                    const message = text || 'No se pudieron guardar los cambios. Intenta nuevamente.';
                    const escapeHtml = s => String(s).replace(/[&<>"']/g, c => (
                        { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]
                    ));
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        html: `<pre style="white-space:pre-wrap;">${escapeHtml(message)}</pre>`
                    });
                }
            })
            .catch(err => {
                console.error('Save failed', err);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Ocurrió un error inesperado. Intenta nuevamente.'
                });
            });
    });
});

{% block scripts %}
<script type="module">
import Alert from '/static/js/modules/Alert.js';  // ruta correcta según tu proyecto

document.addEventListener("DOMContentLoaded", function() {
    const editButton = document.querySelector(".form__edit");
    const formActions = document.querySelector(".form__actions");
    const form = document.querySelector(".form");
    const formFields = document.querySelectorAll(".form input, .form textarea, .form select");
    const cancelButton = document.getElementById("cancelBtn");

    if (!editButton || !formActions || !form) return;

    const originalValues = {};
    formFields.forEach(field => {
        originalValues[field.name] = field.value;
    });

    editButton.addEventListener("click", function(e) {
        e.preventDefault();
        formActions.classList.remove("hide");
        formFields.forEach(field => field.removeAttribute("readonly"));
        editButton.style.display = "none";
    });

    if (cancelButton) {
        cancelButton.addEventListener("click", function(e) {
            e.preventDefault();
            formActions.classList.add("hide");
            formFields.forEach(field => {
                if (originalValues.hasOwnProperty(field.name)) {
                    field.value = originalValues[field.name];
                }
                field.setAttribute("readonly", "true");
            });
            editButton.style.display = "inline-block";
        });
    }

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(async resp => {
            const ct = resp.headers.get('content-type') || '';
            let data = null;
            let text = null;

            if (ct.includes('application/json')) {
                try {
                    data = await resp.json();
                } catch {
                    text = await resp.text();
                }
            } else {
                text = await resp.text();
            }

            if (data && data.success) {
                Alert.success('Perfil actualizado correctamente');

                ["nombres", "apellidos", "telefono", "codigo_estudiante"].forEach(field => {
                    if (data[field] !== undefined) {
                        const f = form.querySelector(`[name="${field}"]`);
                        if (f) {
                            f.value = data[field];
                            originalValues[field] = data[field];
                        }
                    }
                });

                formFields.forEach(field => field.setAttribute("readonly", "true"));
                formActions.classList.add("hide");
                editButton.style.display = "inline-block";

            } else if (data && data.errors) {
                let html = "";
                for (const [field, errs] of Object.entries(data.errors)) {
                    html += `${field}: ${errs.join(", ")}\n`;
                }
                Alert.error(html);

            } else {
                Alert.error(text || 'No se pudieron guardar los cambios. Intenta nuevamente.');
            }
        })
        .catch(err => {
            console.error('Save failed', err);
            Alert.error('Ocurrió un error inesperado. Intenta nuevamente.');
        });
    });
});
</script>
{% endblock scripts %}*/
